<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>룸 채팅 및 게임 테스트</title>
    <!-- 부트스트랩 CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      /* 전체 컨테이너: 채팅과 접속 인원 영역 좌우 배치 (7:3 비율) */
      .container-custom {
        display: flex;
        gap: 10px;
      }

      .chat-container {
        flex: 7;
        border: 1px solid #ccc;
        padding: 10px;
      }

      .occupant-container {
        flex: 3;
        border: 1px solid #ccc;
        padding: 10px;
      }

      #chatMessages {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        padding: 5px;
        background-color: #f9f9f9;
        margin-bottom: 10px;
      }

      /* 접속 인원 버튼 그리드 */
      #occupantList {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
      }

      /* 부트스트랩 버튼 스타일 사용, 선택 시 색상 변경 */
      .occupant-btn {
        cursor: pointer;
        transition: background-color 0.3s;
        height: 65px;
      }

      .occupant-btn.selected {
        background-color: #007bff;
        color: white;
      }

      .system-message {
        color: green;
        font-weight: bold;
      }

      .role-message {
        color: blue;
        font-weight: bold;
      }

      /* 투표 확정 버튼 스타일 */
      #voteBtn {
        margin-top: 10px;
        padding: 8px 12px;
        font-size: 16px;
        cursor: pointer;
      }

      .disabled-btn {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
      }

      /* 2차 투표 버튼 컨테이너 */
      #secondVoteContainer {
        display: none;
        margin-top: 10px;
      }

      #secondVoteContainer button {
        margin-right: 10px;
        padding: 8px 12px;
        font-size: 16px;
      }

      @keyframes blink {
        0% {
          opacity: 1;
          background-color: red;
        }

        50% {
          opacity: 0;
          background-color: red;
        }

        100% {
          opacity: 1;
          background-color: red;
        }
      }

      .blink {
        animation: blink 1s infinite;
      }
    </style>
  </head>

  <body>
    <h1>룸 채팅 및 게임 테스트</h1>
    <!-- 사용자 ID 입력 -->
    <div class="form-group">
      <label for="userId">사용자 ID:</label>
      <input type="number" id="userId" class="form-control" placeholder="1" />
      <button id="loginBtn" class="btn btn-primary mt-2">
        로그인 (룸 입장)
      </button>
    </div>
    <!-- 전체 컨테이너: 채팅과 접속 인원 영역 -->
    <div class="container-custom" id="mainContainer" style="display: none">
      <!-- 채팅 영역 -->
      <div class="chat-container" id="chatRoom">
        <h2 id="roomTitle"></h2>
        <div id="chatMessages"></div>
        <input
          type="text"
          id="messageInput"
          class="form-control"
          placeholder="메시지를 입력하세요"
        />
        <button id="sendBtn" class="btn btn-secondary mt-2">전송</button>
      </div>
      <!-- 접속 인원 영역 -->
      <div class="occupant-container" id="roomOccupants">
        <h2>현재 접속 인원</h2>
        <div id="occupantList"></div>
      </div>
    </div>
    <!-- 투표 확정 버튼 (컨테이너 외부) -->
    <div id="voteContainer" style="display: none; margin-top: 10px">
      <button id="voteBtn" class="btn btn-success">투표 확정</button>
      <p id="voteStatus"></p>
    </div>
    <!-- 2차 투표 버튼 컨테이너 (초기에는 숨김) -->
    <div id="secondVoteContainer" style="display: none">
      <button id="executeBtn" class="btn btn-danger">사살</button>
      <button id="survivalBtn" class="btn btn-info">생존</button>
    </div>
    <!-- 게임 상태 영역 -->
    <div id="gameSection" style="display: none; margin-top: 20px">
      <h2>게임 상태</h2>
      <div id="gameStatus"></div>
      <!-- 테스트용 버튼 추가 -->
      <button id="setNightPhaseBtn" class="btn btn-warning mt-2">
        게임 단계: 밤으로 전환
      </button>
    </div>

    <script>
      // 방 ID 추출 (예: http://localhost:3000/room/1)
      var pathSegments = window.location.pathname.split('/');
      var roomId = pathSegments[pathSegments.length - 1];
      document.getElementById('roomTitle').textContent =
        '채팅룸 (룸 ' + roomId + ')';

      var currentUserId;
      var socket; // 단일 소켓
      var roomInfo; // 최신 방 정보
      var selectedTargetId = null; // 1차 투표 시 선택된 대상의 ID
      var currentUserRole;
      var currentUserIsAlive;
      // 로그인 및 룸 입장
      document
        .getElementById('loginBtn')
        .addEventListener('click', function () {
          var userIdInput = document.getElementById('userId').value;
          if (!userIdInput) {
            alert('사용자 ID를 입력하세요.');
            return;
          }
          currentUserId = Number(userIdInput);
          console.log('입력된 사용자 ID:', currentUserId);

          socket = io('http://localhost:3000/room', {
            auth: { roomId: roomId, userId: currentUserId },
          });

          // UI 표시
          document.getElementById('mainContainer').style.display = 'flex';
          document.getElementById('gameSection').style.display = 'block';
          document.getElementById('voteContainer').style.display = 'block';

          socket.emit('joinRoom', { roomId: roomId, userId: currentUserId });
          socket.emit('requestRoomInfo', { roomId: roomId });

          socket.once('ROOM:JOINED', function (data) {
            roomInfo = data;
            console.log('ROOM:JOINED 수신:', roomInfo);
            updateOccupantList(roomInfo);
          });

          socket.on('ROOM:UPDATED', function (data) {
            roomInfo = data;
            console.log('ROOM:UPDATED 수신:', roomInfo);
            updateOccupantList(roomInfo);
          });

          socket.on('message', function (data) {
            appendChatMessage('[' + data.sender + '] ' + data.message);
          });
          socket.on('CHAT:DEAD', function (data) {
            appendChatMessage('[' + data.sender + '] ' + data.message);
          });

          socket.on('CHAT:MAFIA', function (data) {
            appendChatMessage('[' + data.sender + '] ' + data.message);
          });

          document
            .getElementById('sendBtn')
            .addEventListener('click', sendChatMessage);

          socket.on('YOUR_ROLE', function (data) {
            currentUserRole = data.role;
            currentUserIsAlive = data.isAlive;
            appendChatMessage(data.message, true);
          });

          socket.on('error', function (data) {
            alert('게임 에러: ' + data.message);
          });

          // 추가된 부분: gameEnd 이벤트 핸들러 등록
          socket.on('gameEnd', function (data) {
            // 게임 종료 이벤트 수신 시, 게임 상태 영역에 결과 메시지 표시
            appendChatMessage('게임 종료: ' + data.message);
            document.getElementById('gameStatus').textContent = data.message;
            console.log('게임 종료 데이터:', data);
          });

          // 1차 투표 확정 버튼 클릭 이벤트
          document
            .getElementById('voteBtn')
            .addEventListener('click', function () {
              if (!selectedTargetId) {
                alert('투표할 대상을 선택하세요.');
                return;
              }
              socket.emit(
                'VOTE:FIRST',
                {
                  roomId: roomId,
                  voterId: currentUserId,
                  targetId: Number(selectedTargetId),
                },
                function (response) {
                  console.log('서버 응답 수신:', response);
                  if (!response || !response.success) {
                    alert(
                      response?.message || '서버 응답이 올바르지 않습니다.',
                    );
                    return;
                  }
                  console.log('1차 투표 완료:', {
                    voterId: currentUserId,
                    targetId: selectedTargetId,
                  });
                  var voteBtn = document.getElementById('voteBtn');
                  voteBtn.disabled = true;
                  voteBtn.classList.add('disabled-btn');
                  clearSelection();
                },
              );
            });

          // 수신 이벤트: 2차 투표 진행 지시 (VOTE:SURVIVAL)
          socket.on('VOTE:SURVIVAL', function (data) {
            console.log('VOTE:SURVIVAL 이벤트 수신:', data);
            // 1차 투표 확정 버튼 숨기기/비활성화
            document.getElementById('voteContainer').style.display = 'none';
            // 2차 투표 버튼 컨테이너 보이기
            document.getElementById('secondVoteContainer').style.display =
              'block';
          });

          // 2차 투표: 사살 버튼 클릭
          document
            .getElementById('executeBtn')
            .addEventListener('click', function () {
              socket.emit(
                'VOTE:SECOND',
                {
                  roomId: roomId,
                  voterId: currentUserId,
                  execute: true,
                },
                function (response) {
                  console.log('2차 투표 (사살) 응답:', response);
                  // 2차 투표 후 버튼 숨기기
                  document.getElementById('secondVoteContainer').style.display =
                    'none';
                },
              );
            });
          // 게임 단계 전환 버튼 클릭 이벤트
          document
            .getElementById('setNightPhaseBtn')
            .addEventListener('click', function () {
              socket.emit('SET_PHASE', { roomId: roomId, phase: 'night' });
              // 2차 투표: 생존 버튼 클릭
              document
                .getElementById('survivalBtn')
                .addEventListener('click', function () {
                  socket.emit(
                    'VOTE:SECOND',
                    {
                      roomId: roomId,
                      voterId: currentUserId,
                      execute: false,
                    },
                    function (response) {
                      console.log('2차 투표 (생존) 응답:', response);
                      // 2차 투표 후 버튼 숨기기
                      document.getElementById(
                        'secondVoteContainer',
                      ).style.display = 'none';
                    },
                  );
                });
            });
        }); //오류해결 괄호
      // 채팅 메시지 추가 함수
      function appendChatMessage(message, isRole) {
        var chatMessagesDiv = document.getElementById('chatMessages');
        var messageElement = document.createElement('div');
        if (isRole) {
          messageElement.classList.add('role-message');
        }
        messageElement.textContent = message;
        chatMessagesDiv.appendChild(messageElement);
      }

      // 채팅 메시지 전송 함수
      function sendChatMessage() {
        var messageInputElem = document.getElementById('messageInput');
        var message = messageInputElem ? messageInputElem.value : '';
        if (message.trim() === '') return;
        if (currentUserRole === 'mafia') {
          // 마피아일 경우
          socket.emit('chatMafia', {
            roomId: roomId,
            userId: currentUserId,
            message: message,
          });
        } else if (currentUserIsAlive === false) {
          // 죽은 플레이어일 경우
          socket.emit('chatDead', {
            roomId: roomId,
            userId: currentUserId,
            message: message,
          });
        } else {
          socket.emit('chatMessage', {
            roomId: roomId,
            userId: currentUserId,
            message: message,
          });
          if (messageInputElem) {
            messageInputElem.value = '';
          }
        }
      }

      // 접속 인원 업데이트 함수 (부트스트랩 버튼으로 표시)
      function updateOccupantList(roomData) {
        console.log('접속 인원 업데이트:', roomData);
        var occupantListDiv = document.getElementById('occupantList');
        occupantListDiv.innerHTML = '';
        var players = [];
        try {
          players =
            typeof roomData.players === 'string'
              ? JSON.parse(roomData.players)
              : roomData.players;
        } catch (error) {
          players = [];
        }
        players.forEach(function (player) {
          var btn = document.createElement('button');
          if (player.id === currentUserId) {
            btn.className = 'btn btn-secondary occupant-btn';
            btn.disabled = true;
          } else {
            btn.className = 'btn btn-outline-primary occupant-btn';
          }
          btn.textContent = '사용자 ' + player.id;
          btn.dataset.userid = player.id;
          btn.addEventListener('click', function () {
            var allBtns = document.querySelectorAll(
              '.occupant-btn:not([disabled])',
            );
            allBtns.forEach(function (b) {
              b.classList.remove('selected');
            });
            btn.classList.add('selected');
            selectedTargetId = Number(btn.dataset.userid);
            console.log('선택된 대상:', selectedTargetId);
          });
          occupantListDiv.appendChild(btn);
        });
      }

      // 선택 해제 함수
      function clearSelection() {
        var allBtns = document.querySelectorAll('.occupant-btn');
        allBtns.forEach(function (b) {
          b.classList.remove('selected');
        });
        selectedTargetId = null;
      }
    </script>
  </body>
</html>
