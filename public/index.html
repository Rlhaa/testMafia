<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ë£¸ ì±„íŒ… ë° ê²Œì„ í…ŒìŠ¤íŠ¸</title>
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ: ì±„íŒ…ê³¼ ì ‘ì† ì¸ì› ì˜ì—­ ì¢Œìš° ë°°ì¹˜ (7:3 ë¹„ìœ¨) */
        .container-custom {
            display: flex;
            gap: 10px;
        }

        .chat-container {
            flex: 7;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .occupant-container {
            flex: 3;
            border: 1px solid #ccc;
            padding: 10px;
        }

        #chatMessages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 5px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }

        #occupantList {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        /* ë¶€íŠ¸ìŠ¤íŠ¸ë© ë²„íŠ¼ ì‚¬ìš©, ì„ íƒë˜ë©´ ìƒ‰ìƒì´ ë³€í•¨ */
        .occupant-btn {
            cursor: pointer;
            transition: background-color 0.3s;
            height: 65px;
        }

        .occupant-btn.selected {
            background-color: #007bff;
            color: white;
        }

        .system-message {
            color: green;
            font-weight: bold;
        }

        .role-message {
            color: blue;
            font-weight: bold;
        }

        /* íˆ¬í‘œ í™•ì • ë²„íŠ¼ */
        #voteBtn {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
        }

        .disabled-btn {
            opacity: 0.5;
            /* íë ¤ì§€ê²Œ ë§Œë“¤ê¸° */
            pointer-events: none;
            /* í´ë¦­ ë¶ˆê°€ëŠ¥í•˜ê²Œ */
            cursor: not-allowed;
            /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ 'ê¸ˆì§€' ì»¤ì„œ í‘œì‹œ */
        }
    </style>
</head>

<body>
    <h1>ë£¸ ì±„íŒ… ë° ê²Œì„ í…ŒìŠ¤íŠ¸</h1>
    <!-- ì‚¬ìš©ì ID ì…ë ¥ -->
    <div class="form-group">
        <label for="userId">ì‚¬ìš©ì ID:</label>
        <input type="number" id="userId" class="form-control" placeholder="1">
        <button id="loginBtn" class="btn btn-primary mt-2">ë¡œê·¸ì¸ (ë£¸ ì…ì¥)</button>
    </div>
    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ: ì±„íŒ…ê³¼ ì ‘ì† ì¸ì› ì˜ì—­ -->
    <div class="container-custom" id="mainContainer" style="display: none;">
        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-container" id="chatRoom">
            <h2 id="roomTitle"></h2>
            <div id="chatMessages"></div>
            <input type="text" id="messageInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button id="sendBtn" class="btn btn-secondary mt-2">ì „ì†¡</button>
        </div>
        <!-- ì ‘ì† ì¸ì› ì˜ì—­ -->
        <div class="occupant-container" id="roomOccupants">
            <h2>í˜„ì¬ ì ‘ì† ì¸ì›</h2>
            <div id="occupantList"></div>
        </div>
    </div>
    <!-- íˆ¬í‘œ í™•ì • ë²„íŠ¼ (ì»¨í…Œì´ë„ˆ ì™¸ë¶€) -->
    <div id="voteContainer" style="display: none; margin-top: 10px;">
        <button id="voteBtn" class="btn btn-success">íˆ¬í‘œ í™•ì •</button>
    </div>
    <!-- ê²Œì„ ìƒíƒœ ì˜ì—­ -->
    <div id="gameSection" style="display: none; margin-top: 20px;">
        <h2>ê²Œì„ ìƒíƒœ</h2>
        <div id="gameStatus"></div>
    </div>

    <script>
        // ë°© ID ì¶”ì¶œ (ì˜ˆ: http://localhost:3000/room/1)
        var pathSegments = window.location.pathname.split('/');
        var roomId = pathSegments[pathSegments.length - 1];
        document.getElementById('roomTitle').textContent = "ì±„íŒ…ë£¸ (ë£¸ " + roomId + ")";

        var currentUserId;
        var socket;      // ë‹¨ì¼ ì†Œì¼“
        var roomInfo;    // ROOM:JOINED ë˜ëŠ” ROOM:UPDATED ì´ë²¤íŠ¸ë¡œ ìµœì‹  ë°© ì •ë³´ ìˆ˜ì‹ 
        var selectedTargetId = null; // íˆ¬í‘œ ëŒ€ìƒìœ¼ë¡œ ì„ íƒëœ í”Œë ˆì´ì–´ì˜ ID
        document.getElementById("loginBtn").addEventListener("click", function () {
            var userIdInput = document.getElementById("userId").value;
            if (!userIdInput) {
                alert("ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            currentUserId = Number(userIdInput);

            //  ë‹¨ì¼ ì†Œì¼“ ìƒì„± (auth ì˜µì…˜ ì‚¬ìš©)
            socket = io("http://localhost:3000/room", {
                auth: { roomId: roomId, userId: currentUserId }
            });

            //  UI í‘œì‹œ
            document.getElementById("mainContainer").style.display = "flex";
            document.getElementById("gameSection").style.display = "block";
            document.getElementById("voteContainer").style.display = "block";

            //  ë°© ì…ì¥ ìš”ì²­
            socket.emit("joinRoom", { roomId: roomId, userId: currentUserId });

            socket.once("ROOM:JOINED", function (data) {
                roomInfo = data;
                updateOccupantList(roomInfo);
            });

            socket.on("ROOM:UPDATED", function (data) {
                roomInfo = data;
                updateOccupantList(roomInfo);
            });

            socket.on("message", function (data) {
                appendChatMessage("[" + data.sender + "] " + data.message);
            });

            document.getElementById("sendBtn").addEventListener("click", sendChatMessage);

            socket.on("YOUR_ROLE", function (data) {
                appendChatMessage(data.message, true);
            });

            socket.on("error", function (data) {
                alert("ê²Œì„ ì—ëŸ¬: " + data.message);
            });

            //  íˆ¬í‘œ í™•ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì—¬ê¸°ì„œ ì •ìƒì ìœ¼ë¡œ ë“±ë¡)
            document.getElementById("voteBtn").addEventListener("click", function () {
                if (!selectedTargetId) {
                    alert("íˆ¬í‘œí•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
                    return;
                }

                console.log("íˆ¬í‘œ ìš”ì²­ ì „ì†¡:", { roomId, voterId: currentUserId, targetId: Number(selectedTargetId) });

                socket.emit("VOTE:PLAYER", {
                    roomId: roomId,
                    voterId: currentUserId,
                    targetId: Number(selectedTargetId)
                }, (response) => {
                    console.log("ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ :", response); // ğŸ”¹ ì„œë²„ ì‘ë‹µì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì‹ ë˜ëŠ”ì§€ í™•ì¸

                    if (!response || !response.success) {
                        alert(response?.message || "ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }

                    console.log(`ì‚¬ìš©ì ${currentUserId}ê°€ ì‚¬ìš©ì ${selectedTargetId}ì—ê²Œ íˆ¬í‘œ ì™„ë£Œ`);

                    // íˆ¬í‘œ ë²„íŠ¼ì„ ë¹„í™œì„±í™”í•˜ì—¬ ì¶”ê°€ í´ë¦­ ë°©ì§€
                    document.getElementById("voteBtn").classList.add("disabled-btn");

                    clearSelection();
                });
            });



        });

        socket.on("UPDATE_VOTES", function (data) {
            updateVoteUI(data);
        });

        socket.on("VOTE:RESULT", function (data) {
            console.log(`VOTE:RESULT ì´ë²¤íŠ¸ ìˆ˜ì‹  ì„±ê³µ`)
            displayVoteResult(data);
        });

        socket.on("VOTE:COMPLETE", function (data) {
            console.log("ëª¨ë“  ìƒì¡´ í”Œë ˆì´ì–´ê°€ íˆ¬í‘œ ì™„ë£Œ");
            document.getElementById("voteStatus").textContent = data.message;
        });



        // SECONDVOTE ë‹¨ê³„ê°€ ì‹œì‘ë˜ë©´ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        socket.on("SECONDVOTE_START", function () {
            console.log("SECONDVOTE ë‹¨ê³„ ì‹œì‘. íˆ¬í‘œ ë²„íŠ¼ í™œì„±í™”.");
            document.getElementById("voteBtn").classList.remove("disabled-btn");
        });

        //  ìœ ì € ëª©ë¡ì—ì„œ í´ë¦­í•œ í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ëŠ” í•¨ìˆ˜
        function updateOccupantList(roomData) {
            var occupantListDiv = document.getElementById("occupantList");
            occupantListDiv.innerHTML = "";
            var players = [];
            try {
                players = typeof roomData.players === "string" ? JSON.parse(roomData.players) : roomData.players;
            } catch (error) {
                players = [];
            }
            players.forEach(function (player) {
                var btn = document.createElement("button");
                btn.className = "btn btn-outline-primary occupant-btn";
                btn.textContent = "ì‚¬ìš©ì " + player.id;
                btn.dataset.userid = player.id;

                btn.addEventListener("click", function () {
                    if (player.id === currentUserId) {
                        alert("ìê¸° ìì‹ ì—ê²ŒëŠ” íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    document.querySelectorAll(".occupant-btn").forEach((b) => b.classList.remove("selected"));

                    btn.classList.add("selected");
                    selectedTargetId = Number(btn.dataset.userid); // ìˆ«ìë¡œ ë³€í™˜
                    console.log(`ì„ íƒëœ ìœ ì €: ${selectedTargetId}`);
                });

                occupantListDiv.appendChild(btn);
            });
        }

        //  ì„ íƒ í•´ì œ í•¨ìˆ˜
        function clearSelection() {
            document.querySelectorAll(".occupant-btn").forEach((b) => b.classList.remove("selected"));
            selectedTargetId = null;
        }

        //  íˆ¬í‘œ í˜„í™©ì„ UIì— ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateVoteUI(data) {
            const voteListElement = document.getElementById("voteList");
            if (!voteListElement) return;

            voteListElement.innerHTML = "";
            data.forEach(vote => {
                const listItem = document.createElement("li");
                listItem.textContent = `ì‚¬ìš©ì ${vote.voterId} â†’ ì‚¬ìš©ì ${vote.targetId}ì—ê²Œ íˆ¬í‘œ`;
                voteListElement.appendChild(listItem);
            });

            if (data.length >= totalPlayers) {
                document.getElementById("voteStatus").textContent = "ëª¨ë“  ì‚¬ìš©ìê°€ íˆ¬í‘œ ì™„ë£Œ";
            } else {
                document.getElementById("voteStatus").textContent = `í˜„ì¬ íˆ¬í‘œ ì§„í–‰ ì¤‘ (${voteData.length}/${totalPlayers})`;
            }
        }

        //  íˆ¬í‘œ ê²°ê³¼ë¥¼ UIì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayVoteResult(data) {
            console.log(`íˆ¬í‘œ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ ì§„ì…`)
            alert(`ìµœë‹¤ ë“í‘œì: ì‚¬ìš©ì ${data.winnerId} (${data.voteCount}í‘œ)`);
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function appendChatMessage(message, isRole) {
            var chatMessagesDiv = document.getElementById("chatMessages");
            var messageElement = document.createElement("div");
            if (isRole) {
                messageElement.classList.add("role-message");
            }
            messageElement.textContent = message;
            chatMessagesDiv.appendChild(messageElement);
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendChatMessage() {
            var messageInputElem = document.getElementById("messageInput");
            var message = messageInputElem ? messageInputElem.value : "";
            if (message.trim() === "") return;
            socket.emit("chatMessage", { roomId: roomId, userId: currentUserId, message: message });
            if (messageInputElem) {
                messageInputElem.value = "";
            }
        }

        // ì ‘ì† ì¸ì› ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë¶€íŠ¸ìŠ¤íŠ¸ë© ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œ)
        function updateOccupantList(roomData) {
            var occupantListDiv = document.getElementById("occupantList");
            occupantListDiv.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
            var players = [];
            try {
                players = typeof roomData.players === "string" ? JSON.parse(roomData.players) : roomData.players;
            } catch (error) {
                players = [];
            }
            players.forEach(function (player) {
                var btn = document.createElement("button");
                btn.className = "btn btn-outline-primary occupant-btn";
                btn.textContent = "ì‚¬ìš©ì " + player.id;
                btn.dataset.userid = player.id; // data-userid ì†ì„± ì €ì¥
                // í´ë¦­ ì‹œ ì„ íƒ ìƒíƒœ í† ê¸€ (ìì‹ ì—ê²Œ íˆ¬í‘œ ë¶ˆê°€ ì¡°ê±´ì€ ë³„ë„ë¡œ ì²˜ë¦¬)
                btn.addEventListener("click", function () {
                    // ëª¨ë“  ë²„íŠ¼ì—ì„œ ì„ íƒ í•´ì œ
                    var allBtns = document.querySelectorAll(".occupant-btn");
                    allBtns.forEach(function (b) {
                        b.classList.remove("selected");
                    });
                    // í˜„ì¬ ë²„íŠ¼ ì„ íƒ
                    btn.classList.add("selected");
                    selectedTargetId = btn.dataset.userid;
                });
                occupantListDiv.appendChild(btn);
            });
        }

        // ì„ íƒ í•´ì œ í•¨ìˆ˜
        function clearSelection() {
            var allBtns = document.querySelectorAll(".occupant-btn");
            allBtns.forEach(function (b) {
                b.classList.remove("selected");
            });
            selectedTargetId = null;
        }
    </script>
</body>

</html>